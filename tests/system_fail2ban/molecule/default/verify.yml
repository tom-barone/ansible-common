---
- name: "Verify"
  hosts: "all"
  tasks:
    - name: "Check fail2ban package is installed"
      ansible.builtin.command: "dpkg -s fail2ban"
      changed_when: false

    - name: "Check whois package is installed"
      ansible.builtin.command: "dpkg -s whois"
      changed_when: false

    - name: "Read jail.local file"
      ansible.builtin.slurp:
        src: "/etc/fail2ban/jail.local"
      register: "jail_local"

    - name: "Assert jail.local has correct content"
      vars:
        content: "{{ jail_local.content | b64decode }}"
      ansible.builtin.assert:
        that:
          - "'bantime = 48h' in content"
          - "'enabled = true' in content"
        msg: "jail.local missing expected configuration"

    - name: "Check fail2ban service is running"
      ansible.builtin.systemd:
        name: "fail2ban"
      register: "fail2ban_service"

    - name: "Assert fail2ban service is active"
      ansible.builtin.assert:
        that:
          - "fail2ban_service.status.ActiveState == 'active'"
        msg: "fail2ban service is not running"
