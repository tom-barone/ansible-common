---
- name: "Verify"
  hosts: "all"
  tasks:
    # Given logrotate role was applied with default config
    # When we read the generated config file
    # Then it has correct path, user/group, and defaults
    - name: "Slurp test-app logrotate config"
      ansible.builtin.slurp:
        src: "/etc/logrotate.d/test-app"
      register: "test_app_config"

    - name: "Assert test-app config has correct defaults"
      vars:
        content: "{{ test_app_config.content | b64decode }}"
      ansible.builtin.assert:
        that:
          - "'/var/log/test-app/*.log' in content"
          - "'daily' in content"
          - "'rotate 7' in content"
        msg: "test-app logrotate config is incorrect"

    # Given logrotate role was applied with custom frequency and rotate
    # When we read the generated config file
    # Then it contains the custom values
    - name: "Slurp test-custom logrotate config"
      ansible.builtin.slurp:
        src: "/etc/logrotate.d/test-custom"
      register: "test_custom_config"

    - name: "Assert test-custom config has custom values"
      vars:
        content: "{{ test_custom_config.content | b64decode }}"
      ansible.builtin.assert:
        that:
          - "'/var/log/test-custom/*.log' in content"
          - "'su root adm' in content"
          - "'weekly' in content"
          - "'rotate 14' in content"
        msg: "test-custom logrotate config is incorrect"

    - name: "Run debug logrotate to verify config"
      ansible.builtin.shell: "logrotate --debug /etc/logrotate.conf 2>&1"
      become: true
      changed_when: false
      register: "logrotate_debug"

    - name: "Print logrotate debug output for troubleshooting"
      ansible.builtin.debug:
        var: "logrotate_debug.stdout"

    - name: "Assert both apps are included in logrotate debug output"
      ansible.builtin.assert:
        that:
          - "'test-app' in logrotate_debug.stdout"
          - "'test-custom' in logrotate_debug.stdout"
        msg: "logrotate debug output does not include expected configs"
