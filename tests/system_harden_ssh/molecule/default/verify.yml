---
- name: "Verify"
  hosts: "all"
  tasks:
    - name: "Read sshd_config"
      ansible.builtin.slurp:
        src: "/etc/ssh/sshd_config"
      register: "sshd_config"

    - name: "Assert sshd_config has correct content"
      vars:
        content: "{{ sshd_config.content | b64decode }}"
      ansible.builtin.assert:
        that:
          - "'PermitRootLogin no' in content"
          - "'PasswordAuthentication no' in content"
          - "'X11Forwarding no' in content"
        msg: "sshd_config missing expected configuration"

    - name: "Read authorized_keys"
      ansible.builtin.slurp:
        src: "/root/.ssh/authorized_keys"
      register: "authorized_keys"

    - name: "Assert authorized_keys has correct content"
      vars:
        content: "{{ authorized_keys.content | b64decode }}"
      ansible.builtin.assert:
        that:
          - "'ssh-ed25519 AAAAC3 test@test' in content"
        msg: "authorized_keys missing expected SSH key"

    - name: "Check ssh service status"
      ansible.builtin.systemd:
        name: "ssh"
      register: "ssh_service"

    - name: "Assert ssh service is active"
      ansible.builtin.assert:
        that:
          - "ssh_service.status.ActiveState == 'active'"
        msg: "ssh service is not running"
